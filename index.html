<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Audiobook Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: auto;
    padding: 10px;
    max-width: 600px;
    background: #f5f5f5;
  }
  h2 {
    text-align: center;
    font-size: 1.4rem;
    margin-bottom: 10px;
  }
  input, select, button {
    font-size: 1rem;
    padding: 8px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
  }
  button:active { background: #45a049; }
  .controls {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
  }
  .controls button {
    flex: 1 1 48%;
  }
  #textDisplay {
    background: white;
    border-radius: 5px;
    padding: 10px;
    height: 300px;
    overflow-y: auto;
    margin-top: 10px;
    line-height: 1.5;
  }
  .highlight {
    background: yellow;
  }
</style>
</head>
<body>

<h2 id="bookTitle">Audiobook Player</h2>

<input type="file" id="fileInput" accept=".pdf,.txt">

<select id="voiceSelect"></select>

<label for="rate">Speed:</label>
<input type="number" id="rate" value="1" step="0.1" min="0.5" max="2">

<div class="controls">
  <button id="playBtn">‚ñ∂ Play</button>
  <button id="pauseBtn">‚è∏ Pause</button>
  <button id="resumeBtn">üîÑ Resume</button>
  <button id="stopBtn">‚èπ Stop</button>
</div>

<div id="textDisplay"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
let speech = window.speechSynthesis;
let voices = [];
let textWords = [];
let currentIndex = 0;
let utterance;

// Only keep enhanced American Male, American Female, British Male voices
function loadVoices() {
    let allVoices = speech.getVoices();
    voices = allVoices.filter(v =>
        (v.lang.startsWith("en-US") && (v.name.includes("Alex") || v.name.includes("Samantha"))) ||
        (v.lang.startsWith("en-GB") && v.name.includes("Daniel"))
    );

    let voiceSelect = document.getElementById('voiceSelect');
    voiceSelect.innerHTML = '';
    voices.forEach((voice, i) => {
        let opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(opt);
    });
}

speech.onvoiceschanged = loadVoices;
loadVoices();

document.getElementById('fileInput').addEventListener('change', async function(){
    let file = this.files[0];
    if (!file) return;
    document.getElementById('bookTitle').textContent = file.name.replace(/\.[^/.]+$/, "");

    let text = '';
    if (file.name.toLowerCase().endsWith('.pdf')) {
        let pdfData = await file.arrayBuffer();
        let pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            let page = await pdf.getPage(i);
            let content = await page.getTextContent();
            text += content.items.map(it => it.str).join(' ') + '\n';
        }
    } else {
        text = await file.text();
    }

    displayText(text);
});

function displayText(text) {
    let container = document.getElementById('textDisplay');
    container.innerHTML = '';
    textWords = text.split(/\s+/);
    textWords.forEach((word, i) => {
        let span = document.createElement('span');
        span.textContent = word + ' ';
        span.addEventListener('click', () => {
            currentIndex = i;
            speech.cancel();
            speakFrom(currentIndex);
        });
        container.appendChild(span);
    });
}

function highlightWord(index) {
    let container = document.getElementById('textDisplay');
    let spans = container.querySelectorAll('span');
    spans.forEach(s => s.classList.remove('highlight'));
    if (spans[index]) {
        spans[index].classList.add('highlight');
        spans[index].scrollIntoView({ block: 'center', behavior: 'smooth' });
    }
}

function speakFrom(index) {
    if (index >= textWords.length) return;
    highlightWord(index);
    utterance = new SpeechSynthesisUtterance(textWords[index]);
    utterance.voice = voices[document.getElementById('voiceSelect').value];
    utterance.rate = parseFloat(document.getElementById('rate').value);

    utterance.onend = () => {
        currentIndex++;
        speakFrom(currentIndex);
    };

    speech.speak(utterance);
}

document.getElementById('playBtn').onclick = () => {
    speech.cancel();
    currentIndex = 0;
    speakFrom(currentIndex);
};
document.getElementById('pauseBtn').onclick = () => speech.pause();
document.getElementById('resumeBtn').onclick = () => speech.resume();
document.getElementById('stopBtn').onclick = () => speech.cancel();
</script>

</body>
</html>