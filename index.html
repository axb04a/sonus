<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Audiobook Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: system-ui, sans-serif;
    max-width: 500px;
    margin: auto;
    padding: 20px;
    background: #f5f5f5;
  }
  h2 {
    text-align: center;
    font-size: 1.5rem;
    margin-bottom: 20px;
  }
  input, select, button {
    font-size: 1rem;
    padding: 10px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
  }
  button:active {
    background: #45a049;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  .controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .controls button {
    flex: 1 1 48%;
    min-width: 100px;
  }
</style>
</head>
<body>

<h2 id="bookTitle">Audiobook Player</h2>

<input type="file" id="fileInput" accept=".pdf,.txt">

<label for="voiceSelect">Voice:</label>
<select id="voiceSelect"></select>

<label for="rate">Speed:</label>
<input type="number" id="rate" value="1" step="0.1" min="0.5" max="2">

<div class="controls">
  <button id="playBtn">‚ñ∂ Play</button>
  <button id="pauseBtn">‚è∏ Pause</button>
  <button id="resumeBtn">üîÑ Resume</button>
  <button id="stopBtn">‚èπ Stop</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
let speech = window.speechSynthesis;
let voices = [];
let textChunks = [];
let currentChunk = 0;
let utterance;

function loadVoices() {
    voices = speech.getVoices();
    let voiceSelect = document.getElementById('voiceSelect');
    voiceSelect.innerHTML = '';
    voices.forEach((voice, i) => {
        let opt = document.createElement('option');
        opt.value = i;
        opt.textContent = voice.name + (voice.default ? ' (default)' : '');
        voiceSelect.appendChild(opt);
    });
}

speech.onvoiceschanged = loadVoices;
loadVoices();

document.getElementById('fileInput').addEventListener('change', async function(){
    let file = this.files[0];
    if (!file) return;
    document.getElementById('bookTitle').textContent = file.name.replace(/\.[^/.]+$/, "");
    
    if (file.name.toLowerCase().endsWith('.pdf')) {
        let pdfData = await file.arrayBuffer();
        let pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            let page = await pdf.getPage(i);
            let content = await page.getTextContent();
            fullText += content.items.map(it => it.str).join(' ') + '\n';
        }
        prepareText(fullText);
    } else {
        let text = await file.text();
        prepareText(text);
    }
});

function prepareText(text) {
    // Split into ~150-word chunks for smoother speech
    textChunks = text.match(/(.{1,900})(\s|$)/g);
    currentChunk = 0;
}

function speakChunk() {
    if (currentChunk >= textChunks.length) return;
    utterance = new SpeechSynthesisUtterance(textChunks[currentChunk]);
    utterance.voice = voices[document.getElementById('voiceSelect').value];
    utterance.rate = parseFloat(document.getElementById('rate').value);
    utterance.onend = () => { currentChunk++; speakChunk(); };
    speech.speak(utterance);
}

document.getElementById('playBtn').onclick = () => {
    speech.cancel();
    currentChunk = 0;
    speakChunk();
};
document.getElementById('pauseBtn').onclick = () => speech.pause();
document.getElementById('resumeBtn').onclick = () => speech.resume();
document.getElementById('stopBtn').onclick = () => speech.cancel();
</script>

</body>
</html>
